<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document Search</title>
    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/jquery-3.6.0.min.js"></script>
  </head>

  <body>
    <h1>Ask a Question</h1>
    <form id="query-form">
      <input
        type="text"
        name="q"
        id="query-input"
        placeholder="Enter a question..."
        required
      />
      <button type="submit">Search</button>
    </form>

    <div id="results">
      <h2>Results</h2>
      <ul id="results-list"></ul>
    </div>

    <script>
      $("#query-form").on("submit", function (e) {
        e.preventDefault();
        const formData = $(this).serialize();
        const $list = $("#results-list");
        $list.html("<li>Searching...</li>");

        $.post("/query", formData, function (data) {
          $list.empty();
          if (!data.results || !data.results.length) {
            $list.append("<li>No results found.</li>");
          } else {
            data.results.forEach((item) => {
              const tags = item.tags?.length
                ? `<em>Tags:</em> ${item.tags}`
                : "";
              $list.append(`<li>
    <strong>${item.source}</strong><br>
    <small>Distance: ${item.distance.toFixed(4)}</small><br><br>
    <div>${item.preview}</div>
    <div style="color: #94a3b8; font-size: 0.9em; margin-top: 0.25rem;">${tags}</div>
  </li>`);
            });
          }
        }).fail(function () {
          $list.html(
            '<li style="color: #f87171;">Error retrieving results.</li>'
          );
        });
      });

      $(document).ready(function () {
          console.log("DOM ready, setting up handlers");

          function appendMessage(role, text) {
            const $chat = $("#chat-body");
            const cls = role === "user" ? "color: #60a5fa;" : "color: #facc15;";
            const escapedText = $('<div>').text(text).html().replace(/\n/g, "<br>");
            $chat.append(`<p style="${cls}"><strong>${role}:</strong> ${escapedText}</p>`);
            $chat.scrollTop($chat[0].scrollHeight);
          }

          $("#chat-send").on("click", function () {
            console.log("Send clicked");
            const msg = $("#chat-input").val().trim();
            if (!msg) return;
            appendMessage("user", msg);
            $("#chat-input").val("");

            $.post("/chat", { message: msg })
              .done(function (data) {
                console.log("POST /chat response:", data);
                appendMessage("assistant", data.reply);
              })
              .fail(function () {
                appendMessage("assistant", "‚ö†Ô∏è Failed to respond.");
              });
          });

          $("#chat-input").on("keypress", function (e) {
            if (e.which === 13) $("#chat-send").click();
          });
        });
    </script>
    <div id="chat-widget">
      <div id="chat-header">üí¨ Chatbot</div>
      <div id="chat-body"></div>
      <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ask something..." />
        <button id="chat-send">Send</button>
      </div>
    </div>
  </body>
</html>
