<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Document Manager</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
  <div class="container">
    <!-- Left Column: Document Manager -->
    <div class="column">
      <h2>Document Manager</h2>
      <form method="get" action="/">
        <input type="text" name="q" value="{{ query }}" placeholder="Filter documents..." />
        <button type="submit">Filter</button>
      </form>
      <ul>
        {% for doc in documents %}
          <li>
            <strong>{{ doc.title }}</strong><br />
            <small>ID: {{ doc.id }}</small>
          </li>
        {% endfor %}
        {% if documents|length == 0 %}
          <li><em>No results found.</em></li>
        {% endif %}
      </ul>
    </div>

    <!-- Right Column: LLM Chat and Search -->
    <div class="column">
      <h2>Assistant Chat</h2>
      <div id="chat-box" style="height: 300px; overflow-y: auto; background-color: #1a1a1a; border: 1px solid #333; padding: 1rem; border-radius: 4px;">
        <div><strong>Assistant:</strong> Hello! How can I help you today?</div>
      </div>
      <form id="chat-form" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <input type="text" id="user-input" placeholder="Type a message..." style="flex: 1;" />
        <button type="submit">Send</button>
      </form>

      <h2 style="margin-top: 2rem;">Search Documents</h2>
      <form id="search-form" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <input type="text" id="search-query" placeholder="Enter search text..." style="flex: 1;" />
        <button type="submit">Search</button>
      </form>
      <div id="search-results" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <script>
function escapeHtml(str) {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}


    // Chat
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;

      const userMsg = document.createElement('div');
      userMsg.innerHTML = `<strong>You:</strong> ${msg}`;
      chatBox.appendChild(userMsg);

      const botMsg = document.createElement('div');
      botMsg.innerHTML = `<strong>Assistant:</strong> <em>Thinking...</em>`;
      chatBox.appendChild(botMsg);

      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ message: msg })
      })
        .then(res => res.json())
        .then(data => {
const formatted = data.response
  .replace(/```(.*?)\n([\s\S]*?)```/g, (_, lang, code) => {
    return `<pre><code class="language-${lang}">${escapeHtml(code)}</code></pre>`;
  });

botMsg.innerHTML = `<strong>Assistant:</strong><br>${formatted}`;
          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(err => {
          botMsg.innerHTML = `<strong>Assistant:</strong> <em>Error: ${err}</em>`;
        });

      chatBox.scrollTop = chatBox.scrollHeight;
      chatInput.value = '';
    });

    // Search
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-query');
    const searchResults = document.getElementById('search-results');

    searchForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (!query) return;

      searchResults.innerHTML = `<em>Searching...</em>`;

      fetch(`/search?q=${encodeURIComponent(query)}&top_k=5`)
        .then(res => res.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            searchResults.innerHTML = data.results.map(result => `
<div class="search-result">
  <div><strong>Source:</strong> ${result.source || "unknown"}</div>
  <div><strong>Match Score:</strong> ${result.score?.toFixed(4) || "n/a"}</div>
  <div style="margin-top: 0.5rem;">${result.text}</div>
</div>
            `).join('');
          } else {
            searchResults.innerHTML = `<em>No matches found.</em>`;
          }
        })
        .catch(err => {
          searchResults.innerHTML = `<em>Error: ${err}</em>`;
        });
    });
  </script>
</body>
</html>
